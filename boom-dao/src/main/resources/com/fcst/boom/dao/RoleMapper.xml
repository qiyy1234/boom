<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fcst.boom.dao.RoleDao" >
  <resultMap id="roleResult" type="Role">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="enname" column="enname" />
		<result property="roleType" column="roleType" />
		<result property="dataScope" column="dataScope" />
		<result property="remark" column="remark" />
		<result property="useable" column="useable" />
		<result property="create_user" column="create_user" />
		<result property="create_date" column="create_date" />
		<result property="updateUser" column="updateUser" />
		<result property="updateDate" column="updateDate" />
		<result property="sysData" column="sysData" />
		<result property="office.name" column="office.name" />
		
		<collection property="officeList" ofType="Office">
		  <id property="id" column="officeList.id" />		
		</collection>
		
		<collection property="menuList" ofType="Menu">
			<id property="id" column="menuList.id" />
		</collection>
		
  </resultMap>
		
	<select id="findList" resultMap="roleResult" >
	  SELECT
	a.id,
	a.office_id AS "office.id",
	a. NAME,
	a.enname,
	a.role_type AS roleType,
	a.data_scope AS dataScope,
	a.remark,
	a.create_user ,
	DATE_FORMAT(a.create_date,'%Y-%m-%d %H:%i:%s') AS create_date ,
	a.update_user AS "updateBy.id",
	a.update_date updateData,
	a.del_flag AS "delFlag",
	o. NAME AS "office.name",
	o. CODE,
	a.useable AS useable  ,
	ro.office_id AS "officeList.id"
		FROM sys_role a
	      LEFT JOIN sys_office o ON o.id = a.office_id
	      LEFT JOIN sys_user_role  ur ON   ur.role_id = a.id
	      LEFT JOIN sys_user u ON u.id = ur.user_id
	      LEFT JOIN sys_role_office ro ON ro.role_id = a.id
		WHERE a.del_flag = "0"  
 		<if test="role.user != null and role.user.id != null and role.user.id != ''">
			AND u.id = #{user.id}
		</if>
		<if test="role.user != null and role.user.loginName != null and role.user.loginName != ''">
			AND u.login_name = #{user.loginName}
		</if>
			<!-- 数据范围过滤 -->
		${role.sqlMap.dsf}
		ORDER BY o.code, a.name 
	</select>
	
		<select id="findRoleList" resultMap="roleResult" >
	  SELECT
	a.id,
	a.office_id AS "office.id",
	a. NAME,
	a.enname,
	a.role_type AS roleType,
	a.data_scope AS dataScope,
	a.remark,
	a.create_user ,
	DATE_FORMAT(a.create_date,'%Y-%m-%d %H:%i:%s') AS create_date ,
	a.update_user AS "updateBy.id",
	a.update_date updateData,
	a.del_flag AS "delFlag",
	o. NAME AS "office.name",
	o. CODE,
	a.useable AS useable  ,
	ro.office_id AS "officeList.id"
		FROM sys_role a
	      LEFT JOIN sys_office o ON o.id = a.office_id
	      LEFT JOIN sys_user_role  ur ON   ur.role_id = a.id
	      LEFT JOIN sys_user u ON u.id = ur.user_id
	      LEFT JOIN sys_role_office ro ON ro.role_id = a.id
		WHERE a.del_flag = "0"
 		<if test="role.user != null and role.user.id != null and role.user.id != ''">
			AND u.id = #{user.id}
		</if>
		<if test="role.user != null and role.user.loginName != null and role.user.loginName != ''">
			AND u.login_name = #{user.loginName}
		</if>
			<!-- 数据范围过滤 -->
		${role.sqlMap.dsf}
		ORDER BY o.code, a.name 
	</select>
	
	<select id="findAllRoleList" resultMap="roleResult">
		SELECT
	a.id,
	a.office_id AS "office.id",
	a. NAME,
	a.enname,
	a.role_type AS roleType,
	a.data_scope AS dataScope,
	a.remark,
	a.create_user ,
	DATE_FORMAT(a.create_date,'%Y-%m-%d %H:%i:%s') AS create_date ,
	a.update_user AS "updateBy.id",
	a.update_date updateData,
	a.del_flag AS "delFlag",
	o. NAME AS "office.name",
	o. CODE,
	a.useable AS useable 
		FROM sys_role a
		LEFT JOIN sys_office o ON o.id = a.office_id
		ORDER BY o.code, a.name
	</select>
	
	<select id="findAllList" resultMap="roleResult">
		SELECT
	a.id,
	a.office_id AS "office.id",
	a. NAME,
	a.enname,
	a.role_type AS roleType,
	a.data_scope AS dataScope,
	a.remark,
	a.create_user ,
	DATE_FORMAT(a.create_date,'%Y-%m-%d %H:%i:%s') AS create_date ,
	a.update_user AS "updateBy.id",
	a.update_date updateData,
	a.del_flag AS "delFlag",
	o. NAME AS "office.name",
	o. CODE,
	a.useable AS useable 
		FROM sys_role a
		LEFT JOIN sys_office o ON o.id = a.office_id
		ORDER BY o.code, a.name
	</select>
  
  	<select id="getRoleList" resultMap="roleResult"  parameterType="com.fcst.boom.dao.RoleDao">
		SELECT 
			r.id,
    		r.name,
    		r.enname,
			r.create_user AS createUser,
			DATE_FORMAT(r.create_date,'%Y-%m-%d %H:%i:%s') as createDate
		FROM sys_role r
		where 1=1 
			<if test="role.name!=null and role.name != ''">
				and r.name = #{role.name}
			</if>
	<!-- 	  ${sqlMap.dsf} -->
		order by r.create_date desc
	</select>
	
	<insert id="addRole" parameterType="com.fcst.boom.domain.Role">
		INSERT INTO sys_role (
	id,
	office_id,
	NAME,
	enname,
	role_type,
	data_scope,
	create_user,
	create_date,
	update_user,
	update_date,
    del_flag,
	remark
)
VALUES
	(#{id},#{officeId},#{name},#{enname},#{roleType},#{dataScope},#{createUser},#{createDate},#{createUser},#{createDate},#{delFlag},#{remark})
	</insert>
	
	<select id="getRoleById" resultMap="roleResult">
		SELECT 
			r.id,
    		r.name,
    		r.enname,
    		r.remark,
			r.create_user AS createUser,
			DATE_FORMAT(r.create_date,'%Y-%m-%d %H:%i:%s') AS createDate,
			r.update_user AS updateUser,
			DATE_FORMAT(r.update_date,'%Y-%m-%d %H:%i:%s') AS updateDate
		FROM sys_role r
		WHERE r.id = #{id}
	</select>
	
	<update id="updateRole" parameterType="com.fcst.boom.dao.RoleDao">
		UPDATE sys_role 
		<set>
			<if test="name!=null and name != ''">
				name=#{name},
			</if>
			<if test="enname and enname != ''">
				enname=#{enname},
			</if>
			<if test="remark and remark != ''">
				remark=#{remark},
			</if>
			<if test="updateUser and updateUser != ''">
				update_user=#{updateUser},
			</if>
			<if test="updateDate and updateDate != ''">
				update_date=#{updateDate}
			</if>
		</set>
		where id=#{id}
	</update>
	
	<delete id="deleteRole" parameterType="java.lang.String">
		DELETE FROM sys_role where id=#{id}
	</delete>
	
	<delete id="deleteRolePermissionByRoleId" parameterType="java.lang.String">
		DELETE FROM sys_role_permission WHERE sys_role_id=#{roleId}
	</delete>
	
	<insert id="insertRolePermission" parameterType="java.util.HashMap">
		INSERT INTO sys_role_permission(sys_role_id,sys_permission_id) VALUES (#{roleId},#{permissionId})
	</insert>
	
	<select id="findSelectRoleId" resultMap="roleResult">
		SELECT 
			r.id,
    		r.name
		FROM sys_role r order by r.id desc
	</select>
	
	<select id="findSelectDataScope" resultMap="roleResult">
	    select value as "id" , label as "name" from sys_dict where type = 'sys_data_scope'
	</select>
	
	<delete id="deleteRoleMenu">
		DELETE FROM sys_role_menu WHERE role_id = #{id}
	</delete>
	
	<insert id="insertRoleMenu">
		INSERT INTO sys_role_menu(role_id, menu_id)
		<foreach collection="menuList" item="menu" separator=" union all ">
			SELECT #{id}, #{menu.id} FROM dual

		</foreach>
	</insert>
		
</mapper>
